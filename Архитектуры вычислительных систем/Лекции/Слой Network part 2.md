### Конспект лекции №4: Сетевой слой (Часть 2)
#### 1. Сетевой слой и сетевой стек

**Networking (сетевая инфраструктура)** — это слой ИТ-инфраструктуры, который предоставляет сетевые ресурсы и услуги для обеспечения соединения, маршрутизации и безопасности данных.

- **Проблема коммуникации:** реализация взаимодействия невозможна в рамках закрытых (проприетарных) или монолитных систем. Необходимы общедоступные и совместимые стандарты для использования взаимозаменяемых компонентов.
- **Сетевой стек** — это набор протоколов, работающих последовательно для передачи данных между системами (или приложениями внутри одной системы).
- **Протокол** — соглашение об обработке данных и интерфейсах ввода-вывода для решения конкретной подзадачи в рамках сетевого взаимодействия.

#### 2. Адресация на разных уровнях стека TCP/IP

Стек протоколов включает четыре основных уровня, на каждом из которых используется свой тип адресации:

|Уровень стека|Тип адреса|Пример|
|:--|:--|:--|
|**Прикладной**|DNS-имя, URL|`www.ifmo.ru`|
|**Транспортный**|Номер порта (TCP/UDP)|`443`|
|**Сетевой**|IP-адрес|`192.168.0.103`|
|**Канальный**|MAC-адрес|`BC:EE:7B:5B:E5:E5`|

**Синтетические адреса:** URL или сокет (комбинация IP-адреса и порта).

#### 3. Установление соединения (Client-Server)

Процесс установления связи между программой-клиентом и сервером включает следующие шаги:

1. **Первичная конфигурация:** Назначаются IP-адреса. Программа-сервер при запуске занимает определенный известный порт (например, TCP 80 для веб-сервера).
2. **Запуск клиента:** Клиент занимает свободный порт выше **1024**.
3. **Передача данных модуля:** Клиент передает модулям TCP/IP адрес назначения и номер порта.
4. **Обмен пакетами:** В первом пакете указываются порты и адреса отправителя и получателя. Целевой компьютер отвечает на запрос, после чего устанавливается соединение и начинается передача данных.

#### 4. Основы IPv4-адресации

**IP-адрес** — уникальный числовой идентификатор узла или сети.

- **Длина:** 4 байта (32 бита). Записывается в виде четырех **октетов** (0–255), разделенных точками (W.X.Y.Z).
- **Структура:** Адрес делится на **адрес СЕТИ** (для доставки между сетями через маршрутизацию) и **адрес УЗЛА** (для доставки внутри сети).

**Бесклассовая адресация и маски:** Для определения границ сети используется **маска подсети** (например, `255.255.255.0` или запись `/24`).

- Маска определяет, какая часть IP-адреса относится к сети (единицы в двоичном виде), а какая — к узлу (нули).
- **Зачем нужна маска:** для определения границ LAN, проверки шлюза (gateway) и организации широковещания (broadcast).

**Пример (сеть 192.168.0.0/24):**

- **Network:** 192.168.0.0
- **HostMin:** 192.168.0.1
- **HostMax:** 192.168.0.254
- **Broadcast:** 192.168.0.255

#### 5. Частные (серые) IP-адреса (RFC 1918)

Эти диапазоны зарезервированы для локальных сетей и не используются напрямую в Интернете:

- **Класс A:** 10.0.0.0/8
- **Класс B:** 172.16.0.0/12
- **Класс C:** 192.168.0.0/16

#### 6. Способы соединения IP-сетей

Существует два основных метода, часто используемых одновременно:

1. **Маршрутизация:**
    
    - Общее адресное пространство, видимость «из конца в конец» (end-to-end).
    - Диапазоны адресов в разных сетях **не пересекаются**.
    - Маршрутизаторы принимают решения на основе **таблицы маршрутизации**.
2. **Трансляция адресов (NAT):**
    
    - Разделенное адресное пространство, изоляция локальных сетей (нет прямой видимости).
    - IP-адреса внутри разных локальных сетей могут повторяться.
    - Маршрутизатор на лету меняет адреса в пакетах (и порты в заголовках TCP/UDP), ведя учет замен для возврата ответов.

#### 7. Виды и применение NAT

**NAT (Network Address Translation)** позволяет связывать узлы из немаршрутизируемых (серых) сетей с внешними сетями.

**Основные виды NAT:**

- **Клиентский NAT:** Динамически подменяет сокет отправителя. Используется для доступа локальных компьютеров во внешнюю сеть.
- **Публикация порта (Port Forwarding):** Статическое соответствие внешнего сокета внутреннему. Позволяет подключаться к приложению внутри «серой» сети снаружи.
- **Публикация адреса:** Внутренний адрес полностью соотносится с внешним (типично для облачных виртуальных машин).
- **Симметричный:** Все порты транслируются на порты внешнего адреса.
- **Перегруженный (PAT):** Порты многих внутренних адресов транслируются на порты **одного** внешнего IP.

#### 8. Практическая настройка NAT

В среде **Linux** для настройки NAT используются параметры ядра и утилита `iptables`:

1. Включение пересылки пакетов: `sysctl -w net.ipv4.ip_forward=1`.
2. Настройка маскарадинга (MASQUERADE): `iptables -t nat -A POSTROUTING -o [interface] -s 10.0.0.0/24 -j MASQUERADE`.
3. Проброс порта (DNAT): `iptables -t nat -A PREROUTING -i [interface] -p tcp --dport 55022 -j DNAT --to-destination 10.0.0.2:22`.

Для сохранения правил используются команды `iptables-save` или пакет `iptables-persistent`. В **VirtualBox** настройка проброса портов осуществляется через графический интерфейс в разделе «Сеть -> Дополнительно».