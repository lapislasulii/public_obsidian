

## Обзор и цели практической работы №2

Лекция носит практический характер и чередуется с теоретическими занятиями. В прошлый раз обсуждались аппаратные платформы, включая состав, архитектуру ЦПУ и периферию.

Текущая лекция посвящена пояснениям по второй практической работе, которая уже опубликована. Мы вынуждены опережать лекционный курс по практикам.

**Тема практической работы №2:** Сетевое взаимодействие в Linux.

**Основные задачи работы:**

1. Освоение конфигурации хостов на Linux.
2. Переименование хостов и назначение IP-адресов.
3. Настройка NAT и работа с фаерволами.
4. Работа с **SSH (Sec Shell)** — это очень важный практический навык.
5. Настройка инфраструктуры для удаленной разработки: установка Jupyter Notebook на удаленном хосте и подключение к нему. Это симулирует работу на удаленном хосте с видеокартами, что необходимо для создания сильного искусственного интеллекта. Это описывается как "Home Brew Google Collab".

**Теоретический контекст:** Краткие теоретические сведения даются сейчас. Лекция по сетевой подсистеме будет позже, хотя лектор предложил поменять местами темы и провести сначала лекцию по сетевой подсистеме, а затем по подсистеме хранения.

## Настройка сети в Linux

Для выполнения работы необходимо настроить сеть в виртуальных машинах.

Настройка сети в VirtualBox подробно освещена в старом видео, но в нем используется CentOS (Red Hat ветка), тогда как сейчас используются Debian или Ubuntu, где есть свои нюансы.

**Способы настройки сети в Linux:**

1. Стандартные конфигурационные файлы службы сети.
2. Утилиты (настройка временна, живет до перезагрузки или перезапуска интерфейса).
3. Менеджеры сети (например, NetworkManager или Netplan) — эти будут обсуждаться на втором курсе.
4. С помощью System D (системы инициализации сети).

В данной работе предлагается использовать **стандартные конфигурационные файлы**.

### Диагностика сети и адресация

Для диагностики состояния сети в современных Линуксах используется утилита **`ip`**. С ее помощью можно также настраивать сетевые интерфейсы (назначать/удалять адреса, писать маршруты).

- Команда `ip address` (или `ip a`) выводит IP-адреса на хосте.
- Отображаются два интерфейса (например): `lo` (интерфейс-заглушка, его не следует трогать) и физический сетевой интерфейс, например, **`ENP0s3`** (название может отличаться, например, ETH0, S0 и т.д.).

**Типы адресов:**

- **Аппаратный адрес (MAC-адрес):** 6 байт, прописывается на заводе в ПЗУ адаптера. Используется для обнаружения устройств в пределах локальной сети (локалки).
- **IP-адрес:** Хостовый адрес, необходимый для работы в составной сети, например, в интернете.

### Конфигурационные файлы сети

Для стабильной конфигурации используется текстовый редактор (`nano`) для редактирования файла `/etc/network/interfaces`. Это классический файл для дистрибутивов Debian.

- **Netplan:** В новых версиях Ubuntu (например, 22-м сервере) может использоваться конфигуратор Netplan через YAML.
- **Директивы в файле `interfaces`:**
    - `aut` (или `auto`): Команда, заставляющая Linux инициировать интерфейс при старте системы.
    - `allow-hotplug`: Директива, заставляющая службу сети настраивать интерфейс, как только он появляется в системе (например, USB-адаптер).

**Назначение IP-адресов:**

1. **Динамическое (DHCP):** Указывается `dhcp`. Сетевой интерфейс обращается к DHTP-серверу (Dynamic Host Configuration Protocol) в локальной сети и получает от него IP-адреса и конфигурации автоматически.
2. **Статическое (Static):** IP-адреса и маска указываются вручную.

**Применение настроек:** После изменения конфигурационного файла его необходимо прочитать, перезапустив службу сети с помощью утилиты **`System CTL`** (утилита управления сервисами из комплекта System D): `System CTL restart networking service`.

### Режимы сети VirtualBox и DHCP

VirtualBox предлагает множество режимов виртуализации сети. **DHCP-сервер** внутри VirtualBox активируется только в режимах **NAT** и **NAT Network**.

- **Сетевой мост (Bridge):** Получение IP зависит от реальной сетевой инфраструктуры (реальный DHCP).
- **Внутренняя сеть (Internal Network):** Изолированная локальная сетка внутри VirtualBox; DHCP-сервера там нет, адреса автоматически не получить.

В работе понадобится настроить два сетевых интерфейса на одном Linux: один, например, в режиме NAT, другой — во внутренней сети.

## Концепция NAT (Network Address Translation)

**Проблема IPV4:** IPV4-адреса закончились в 2008 году. NAT позволяет продолжать использовать IPV4.

- **Серые IP-адреса:** Используются в изолированных локальных сетях (например, подсеть 192.168.0.0/16). Они не маршрутизируются в интернете.
- **Белые IP-адреса:** Публичные IP, используемые в интернете.

NAT технологически соединяет локальную сеть с серым диапазоном IP с интернетом, позволяя хостам из серой сетки ходить в белую и получать ответы. NAT используется повсеместно (роутеры, ITMO Wi-Fi, раздача интернета со смартфона).

### Виды NAT

В работе будут использоваться два режима: **Клиентский NAT (SNAT)** и **Публикация порта (DNAT)**.

#### 1. Публикация адреса (1:1 Мэппинг)

Это статическое сопоставление (мэппинг) одного серого IP-адреса белому IP-адресу. Например, в облачных платформах можно нажать кнопку "Хочу белый IP". Роутер облачной платформы меняет IP-адрес получателя с белого на серый (при входящем пакете) и отправителя с серого на белый (при исходящем пакете). При этом порты не затрагиваются. Эта схема позволяет выпустить наружу ровно один компьютер.

#### 2. Клиентский NAT (SNAT, Source NAT)

Используется, когда за одним NAT'ом находится много компьютеров (смартфон, телевизор, робот-пылесос).

**Роль портов:**

- Порт — это номер очереди, который занимает приложение или процесс, работающий через сеть.
- Транспортный уровень (в стеке инкапсуляции сообщений) занимается диспетчеризацией потоков между приложениями на компьютере.
- Серверы используют известные порты (например, 443 для HTTPS). Клиенты (например, вкладки браузера) также имеют свои номера портов.
- Ответ из интернета содержит номер порта получателя, что позволяет операционной системе записать сетевое сообщение в нужную очередь для нужного процесса.

**Механизм SNAT:**

- Когда пакет уходит из локальной сети, NAT на роутере **заменяет исходящий серый IP-адрес и порт браузера на комбинацию внешнего (белого) IP-адреса и уникальный внешний порт**.
- Внешний порт выступает в роли первичного ключа (идентификатора) конкретного соединения конкретного приложения с конкретного компьютера локальной сети.
- Когда ответ приходит обратно, роутер смотрит в свою динамическую таблицу и меняет внешний IP и порт обратно на внутренние, направляя пакет нужному клиенту.

#### 3. DNAT (Destination NAT/Проброс портов)

Используется для доступа к локальным сервисам извне (часто называется "виртуальный сервер" или "проброс портов" в веб-интерфейсах роутеров).

- DNAT — это статическое сопоставление, настраиваемое на роутере: запрос, пришедший на реальный IP-адрес и определенный внешний порт, пробрасывается во внутреннюю сеть на конкретный серый IP-адрес и порт внутреннего сервиса.

## Настройка удаленного доступа и фаервола

### SSH (Secure Shell)

SSH — это зашифрованный канал для удаленного текстового терминала, используемый для доступа к удаленным Linux/Unix-хостам (порт 22 по умолчанию).

- **Подключение:** Используется команда `ssh имя_пользователя@IP_адрес_сервера`.
- **Безопасность (MITM-атака):** При первом подключении сервер показывает отпечаток открытого ключа (хэш SCH 256), который необходимо сверить с администратором сервера для подтверждения подлинности и предотвращения атаки "Человек посередине" (Man-in-the-Middle).
- **Конфигурация сервера:** Необходимо работать с файлом `/etc/ssh/sshd_config` (настройка сервера), а не с `/etc/ssh/ssh_config` (настройка клиента). После изменений сервер нужно перезапускать (`System CTL restart` или `reload`).

### Проброс портов (DNAT) через VirtualBox

Для подключения к сервису внутри VM (например, SSH) снаружи (с хостовой машины) используется проброс портов в настройках VirtualBox.

- Выставляется маппинг: Адрес хоста (например, 127.0.0.1) и Порт хоста (например, 3000) пробрасываются на Адрес гостя (IP-адрес VM, например, 10.0.2.15) и Порт гостя (порт сервиса, например, 22 для SSH).
- VirtualBox поднимает сервис на хосте, который прослушивает внешний порт (например, 3000) и выполняет DNAT, перенаправляя трафик внутрь VM.

### Управление виртуальными машинами

В работе потребуются две VM (одна — шлюз/гейтвей, другая — клиентская).

- **Клонирование:**
    - **Полный клон:** Полная независимая копия, занимает много места.
    - **Связанный клон:** Зависимая копия, занимает меньше места (хранит только инкрементальные изменения относительно исходного снимка).
- **Важно:** Всегда генерировать новые MAC-адреса при клонировании, чтобы избежать конфликтов в сети.
- Для переименования хостов используется команда **`Hostname Ctl`**.

### Настройка шлюза (Gateway)

Linux-шлюз должен иметь два сетевых интерфейса и работать как интернет-шлюз.

- **Включение IP-форвардинга:** По умолчанию Linux не пропускает пакеты сквозь ядро. Необходимо включить форвардинг, установив параметр ядра `net.ipv4.conf.all.forwarding = 1`.
- Этот параметр выставляется при старте системы через стандартный файл **`/etc/sysctl.conf`**.
- **Настройка Firewall (IP Tables):** С помощью IP tables на шлюзе настраиваются разрешения на трансфер трафика. Необходимо настроить **SNAT** (клиентский) и **DNAT** (публикация порта). В работе будет **два последовательных NAT'а**: один на VirtualBox, другой на Linux-шлюзе.

### Установка Jupyter Notebook

На удаленном (клиентском) хосте устанавливается Jupyter Notebook.

- Поскольку Python является частью инфраструктуры Debian/Ubuntu, прямое изменение модулей может "сломать внутренний мир" дистрибутива.
- Необходимо создать отдельный **виртуальный environment (`venv`)** для питоновского проекта, внутри которого устанавливаются модули (например, Jupyter).
- Это позволяет удаленно запускать Jupyter Notebook и подключаться к нему с хостовой машины через два NAT'а.

Эта практическая работа очень прикладная и содержит сценарии, часто используемые в ИТ-инфраструктуре и ML.